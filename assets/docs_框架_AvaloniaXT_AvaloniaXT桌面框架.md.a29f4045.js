import{_ as s,o as n,c as a,U as l}from"./chunks/framework.83a19234.js";const p="/assets/AvaloniaXT.0e6e51f1.png",u=JSON.parse('{"title":"AvaloniaXT","description":"","frontmatter":{},"headers":[],"relativePath":"docs/框架/AvaloniaXT/AvaloniaXT桌面框架.md","filePath":"docs/框架/AvaloniaXT/AvaloniaXT桌面框架.md","lastUpdated":1768497056000}'),o={name:"docs/框架/AvaloniaXT/AvaloniaXT桌面框架.md"},e=l('<h1 id="avaloniaxt" tabindex="-1">AvaloniaXT <a class="header-anchor" href="#avaloniaxt" aria-label="Permalink to &quot;AvaloniaXT&quot;">​</a></h1><p>Avalonia App Page Helper Dll , Contains MainWindow，SukiUI，Support AOT。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">dotnet add package AvaloniaXT --version 1.0.0</span></span></code></pre></div><h1 id="项目组成" tabindex="-1">项目组成 <a class="header-anchor" href="#项目组成" aria-label="Permalink to &quot;项目组成&quot;">​</a></h1><ul><li>AvaloniaXT Nuget通用页面程序集，包含主窗口和一些通用的扩展方法。</li><li>XTExternalPage 扩展界面程序集，包含定制化的业务界面。</li><li>AvaloniaXT.Desktop 桌面程序启动入口。</li><li>AvaloniaXT.Android 可以运行， Microsoft.Maui.Essentials 可以使用Essentials全部功能。</li><li>SukiUI <a href="https://github.com/kikipoulet/SukiUI" target="_blank" rel="noreferrer">引用的SukiUI项目</a> 修改了ProgressBar的MiniHeight、添加一些控件。</li></ul><h1 id="系统界面" tabindex="-1">系统界面 <a class="header-anchor" href="#系统界面" aria-label="Permalink to &quot;系统界面&quot;">​</a></h1><p><img src="'+p+`" alt="systemimage"></p><h1 id="国际化支持" tabindex="-1">国际化支持 <a class="header-anchor" href="#国际化支持" aria-label="Permalink to &quot;国际化支持&quot;">​</a></h1><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">public override void OnFrameworkInitializationCompleted()</span></span>
<span class="line"><span style="color:#A6ACCD;">  {</span></span>
<span class="line"><span style="color:#A6ACCD;">     // Lang.Resources.Culture = new CultureInfo(&quot;en-US&quot;);</span></span>
<span class="line"><span style="color:#A6ACCD;">     // Register.InitialCulture(&quot;en-US&quot;);    </span></span>
<span class="line"><span style="color:#A6ACCD;">  }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  直接编辑 Resources.resx 添加语言</span></span></code></pre></div><h1 id="aot支持" tabindex="-1">AOT支持 <a class="header-anchor" href="#aot支持" aria-label="Permalink to &quot;AOT支持&quot;">​</a></h1><h2 id="要点" tabindex="-1">要点 <a class="header-anchor" href="#要点" aria-label="Permalink to &quot;要点&quot;">​</a></h2><ol><li>不使用反射</li><li>编译绑定必须置为true</li></ol><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&lt;AvaloniaUseCompiledBindingsByDefault&gt;true&lt;AvaloniaUseCompiledBindingsByDefault&gt;</span></span></code></pre></div><ol start="3"><li>反序列化使用源映射</li></ol><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">// 提供GetJsonOptions静态方法</span></span>
<span class="line"><span style="color:#A6ACCD;">var options = UrlUtilities.GetJsonOptions();</span></span>
<span class="line"><span style="color:#A6ACCD;">options.TypeInfoResolver = ApiJsonContext.Default;</span></span>
<span class="line"><span style="color:#A6ACCD;">var result = JsonSerializer.Deserialize&lt;AdminCodeResult&lt;EcsMainView&gt;&gt;(data, options);</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    [JsonSerializable(typeof(AdminCodeResult&lt;EcsMainView&gt;))]</span></span>
<span class="line"><span style="color:#A6ACCD;">    public partial class ApiJsonContext: JsonSerializerContext</span></span>
<span class="line"><span style="color:#A6ACCD;">    {</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span></code></pre></div><h2 id="sql-orm" tabindex="-1">SQL ORM <a class="header-anchor" href="#sql-orm" aria-label="Permalink to &quot;SQL ORM&quot;">​</a></h2><ul><li>测试使用FreeSQL,Npgsql需升级到最新版本。</li><li>需要在启动项目中包含rd.xml</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">// 项目中包含</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;ItemGroup&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;RdXmlFile Include=&quot;rd.xml&quot; /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;/ItemGroup&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;Directives xmlns=&quot;http://schemas.microsoft.com/netfx/2013/01/metadata&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;Application&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;Assembly Name=&quot;XTExternalPage&quot;  Dynamic=&quot;Required All&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;/Assembly&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;Assembly Name=&quot;FreeSql&quot;  Dynamic=&quot;Required All&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;/Assembly&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;Assembly Name=&quot;Npgsql&quot;  Dynamic=&quot;Required All&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;/Assembly&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;/Application&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;/Directives&gt;</span></span></code></pre></div><h1 id="avaloniaxt使用步骤" tabindex="-1">AvaloniaXT使用步骤 <a class="header-anchor" href="#avaloniaxt使用步骤" aria-label="Permalink to &quot;AvaloniaXT使用步骤&quot;">​</a></h1><p>安装完 AvaloniaXT Nuget包后</p><h2 id="_1、启动入口-添加-font-awesomon支持-可选" tabindex="-1">1、启动入口 添加 Font Awesomon支持（可选） <a class="header-anchor" href="#_1、启动入口-添加-font-awesomon支持-可选" aria-label="Permalink to &quot;1、启动入口 添加 Font Awesomon支持（可选）&quot;">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">public static AppBuilder BuildAvaloniaApp()</span></span>
<span class="line"><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">   Register.AddIcons();</span></span>
<span class="line"><span style="color:#A6ACCD;">   return  AppBuilder.Configure&lt;App&gt;()</span></span>
<span class="line"><span style="color:#A6ACCD;">         .UsePlatformDetect()</span></span>
<span class="line"><span style="color:#A6ACCD;">         .WithInterFont()</span></span>
<span class="line"><span style="color:#A6ACCD;">         .LogToTrace();</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> // 页面中使用</span></span>
<span class="line"><span style="color:#A6ACCD;"> &lt;i:Icon Value=&quot;{Binding Condition}&quot; FontSize=&quot;{Binding Width}&quot; /&gt;</span></span></code></pre></div><h2 id="_2、在app-xaml中添加页面选择器、样式、底部托盘-可选" tabindex="-1">2、在App.xaml中添加页面选择器、样式、底部托盘（可选） <a class="header-anchor" href="#_2、在app-xaml中添加页面选择器、样式、底部托盘-可选" aria-label="Permalink to &quot;2、在App.xaml中添加页面选择器、样式、底部托盘（可选）&quot;">​</a></h2><ul><li>页面和弹窗VM都需要继承XTBasePage(提供GetView()方法，注入视图），弹窗还需要重写IsDialog()方法，返回true。</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">&lt;Application.DataTemplates&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">     &lt;xt:ViewLocator/&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"> &lt;/Application.DataTemplates&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">    &lt;Application.Styles&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;sukiUi:SukiTheme ThemeColor=&quot;Blue&quot;  /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;avalonia:MaterialIconStyles /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">    &lt;/Application.Styles&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">// 项目中包含资源，使用方式</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;ItemGroup&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;AvaloniaResource Include=&quot;Assets\\**&quot; /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;/ItemGroup&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;TrayIcon.Icons&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;TrayIcons&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;TrayIcon Icon=&quot;/Assets/alarm.ico&quot; Clicked=&quot;NativeMenuItem_Show&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">				  ToolTipText=&quot;AvaloniaXT&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">			&lt;TrayIcon.Menu&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">				&lt;NativeMenu&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">					&lt;NativeMenuItem Header=&quot;Settings&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">						&lt;NativeMenu&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">							&lt;NativeMenuItem Header=&quot;Show&quot; Click=&quot;NativeMenuItem_Show&quot;  /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">							&lt;NativeMenuItem Header=&quot;Exit&quot; Click=&quot;NativeMenuItem_Click&quot;  /&gt;							</span></span>
<span class="line"><span style="color:#A6ACCD;">						&lt;/NativeMenu&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">					&lt;/NativeMenuItem&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">				&lt;/NativeMenu&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">			&lt;/TrayIcon.Menu&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;/TrayIcon&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;/TrayIcons&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;/TrayIcon.Icons&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> private void NativeMenuItem_Click(object? sender, EventArgs e)</span></span>
<span class="line"><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">     if (Application.Current?.ApplicationLifetime is IClassicDesktopStyleApplicationLifetime lifetime)</span></span>
<span class="line"><span style="color:#A6ACCD;">     {</span></span>
<span class="line"><span style="color:#A6ACCD;">         lifetime?.Shutdown();</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span></span>
<span class="line"><span style="color:#A6ACCD;">     }</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> private void NativeMenuItem_Show(object? sender, EventArgs e)</span></span>
<span class="line"><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">     if (Application.Current?.ApplicationLifetime is IClassicDesktopStyleApplicationLifetime lifetime)</span></span>
<span class="line"><span style="color:#A6ACCD;">     {</span></span>
<span class="line"><span style="color:#A6ACCD;">         var window = lifetime?.MainWindow;</span></span>
<span class="line"><span style="color:#A6ACCD;">         window.WindowState = WindowState.Normal;</span></span>
<span class="line"><span style="color:#A6ACCD;">         window.Show();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">     }</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span></code></pre></div><h2 id="_3、在app中注入服务" tabindex="-1">3、在App中注入服务 <a class="header-anchor" href="#_3、在app中注入服务" aria-label="Permalink to &quot;3、在App中注入服务&quot;">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">var services = new ServiceCollection();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> // 注入 AvaloniaXT中的服务</span></span>
<span class="line"><span style="color:#A6ACCD;"> services.InitialXTServices();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> // 注入业务界面服务</span></span>
<span class="line"><span style="color:#A6ACCD;"> // services.AddSingleton&lt;DbService&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> // 注入界面，界面ViewModel需要</span></span>
<span class="line"><span style="color:#A6ACCD;"> services.AddSingleton&lt;XTPageBase, PhoneTestViewModel&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> // 注入Dialog界面，需要定义Key</span></span>
<span class="line"><span style="color:#A6ACCD;"> services.AddKeyedSingleton&lt;XTPageBase, SearchDialogViewModel&gt;(&quot;Search&quot;);</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> // 界面配置</span></span>
<span class="line"><span style="color:#A6ACCD;"> services.AddSingleton&lt;IMenuToolService, MenuToolService&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"> _provider = services.BuildServiceProvider();</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  public override void OnFrameworkInitializationCompleted()</span></span>
<span class="line"><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">     // 添加 AvaloniaXT 的方法</span></span>
<span class="line"><span style="color:#A6ACCD;">     ApplicationLifetime?.InitialCompleted(_provider);</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">     base.OnFrameworkInitializationCompleted();</span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span></code></pre></div><h1 id="辅助方法" tabindex="-1">辅助方法 <a class="header-anchor" href="#辅助方法" aria-label="Permalink to &quot;辅助方法&quot;">​</a></h1><h2 id="视图选择器" tabindex="-1">视图选择器 <a class="header-anchor" href="#视图选择器" aria-label="Permalink to &quot;视图选择器&quot;">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">public class EcsTagSelector : DataTemplateSelector</span></span>
<span class="line"><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">     public override string GetKey(object? param)</span></span>
<span class="line"><span style="color:#A6ACCD;">     {</span></span>
<span class="line"><span style="color:#A6ACCD;">         var tag = param as UnitTagModel;</span></span>
<span class="line"><span style="color:#A6ACCD;">         return tag.Type.ToString();</span></span>
<span class="line"><span style="color:#A6ACCD;">     }</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;"> }</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;ItemsControl.DataTemplates&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;selector:EcsTagSelector&gt;		</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;DataTemplate x:Key=&quot;Other&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">			&lt;cp:UnitOther&gt;&lt;/cp:UnitOther&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;/DataTemplate&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;!--&lt;DataTemplate x:Key=&quot;XX&quot;&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">			&lt;cp:UnitXX&gt;&lt;/cp:UnitXX&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		&lt;/DataTemplate&gt;--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	&lt;/selector:EcsTagSelector&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">&lt;/ItemsControl.DataTemplates&gt;</span></span></code></pre></div><h2 id="dialog弹窗" tabindex="-1">Dialog弹窗 <a class="header-anchor" href="#dialog弹窗" aria-label="Permalink to &quot;Dialog弹窗&quot;">​</a></h2><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">// windows窗体</span></span>
<span class="line"><span style="color:#A6ACCD;">await SukiHost.ShowToast();</span></span>
<span class="line"><span style="color:#A6ACCD;">// 支持所有平台</span></span>
<span class="line"><span style="color:#A6ACCD;">InteractiveContainer.ShowToast()</span></span></code></pre></div><h1 id="_1-0-2版本后使用方法" tabindex="-1">1.0.2版本后使用方法 <a class="header-anchor" href="#_1-0-2版本后使用方法" aria-label="Permalink to &quot;1.0.2版本后使用方法&quot;">​</a></h1><h2 id="_1、引入对应包" tabindex="-1">1、引入对应包 <a class="header-anchor" href="#_1、引入对应包" aria-label="Permalink to &quot;1、引入对应包&quot;">​</a></h2><ul><li>AvaloniaXT &gt;1.0.2</li><li>XT.AvaloniaUpdater &gt;1.0.0</li></ul><h2 id="_2、入口代码调整" tabindex="-1">2、入口代码调整 <a class="header-anchor" href="#_2、入口代码调整" aria-label="Permalink to &quot;2、入口代码调整&quot;">​</a></h2><ol><li>桌面版</li></ol><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">sealed</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Program</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// Initialization code. Don&#39;t use any Avalonia, third-party APIs or any</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// SynchronizationContext-reliant code before AppMain is called: things aren&#39;t initialized</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// yet and stuff might break.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">STAThread</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Main</span><span style="color:#89DDFF;">(string[]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">args</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BuildAvaloniaApp</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">StartWithClassicDesktopLifetime</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">args</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AppBuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BuildAvaloniaApp</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        App</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">InitializingEvent </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> App_InitializingEvent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        App</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">UpdateEvent </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> App_UpdateEvent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        App</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">AutoUpdateEvent </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> App_AutoUpdateEvent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> AppBuilder</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Configure</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">App</span><span style="color:#89DDFF;">&gt;()</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">UsePlatformDetect</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithInterFont</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">LogToTrace</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">App_UpdateEvent</span><span style="color:#89DDFF;">(object?</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IApiConfig</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">e</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        App</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MainWindow</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AttachDevTools</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UpdateHelper</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">CallUpdate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemoteApiUrl</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 注入其它页面的服务</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">App_InitializingEvent</span><span style="color:#89DDFF;">(object?</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ServiceCollection</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">e</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span></span>
<span class="line"><span style="color:#A6ACCD;">        e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">InitializeOthers</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// </span><span style="color:#89DDFF;font-style:italic;">&lt;</span><span style="color:#F07178;font-style:italic;">summary</span><span style="color:#89DDFF;font-style:italic;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// 触发更新</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// </span><span style="color:#89DDFF;font-style:italic;">&lt;/</span><span style="color:#F07178;font-style:italic;">summary</span><span style="color:#89DDFF;font-style:italic;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// </span><span style="color:#89DDFF;font-style:italic;">&lt;</span><span style="color:#F07178;font-style:italic;">param</span><span style="color:#89DDFF;font-style:italic;"> </span><span style="color:#C792EA;font-style:italic;">name</span><span style="color:#89DDFF;font-style:italic;">=</span><span style="color:#89DDFF;font-style:italic;">&quot;</span><span style="color:#C3E88D;font-style:italic;">sender</span><span style="color:#89DDFF;font-style:italic;">&quot;</span><span style="color:#89DDFF;font-style:italic;">&gt;&lt;/</span><span style="color:#F07178;font-style:italic;">param</span><span style="color:#89DDFF;font-style:italic;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// </span><span style="color:#89DDFF;font-style:italic;">&lt;</span><span style="color:#F07178;font-style:italic;">param</span><span style="color:#89DDFF;font-style:italic;"> </span><span style="color:#C792EA;font-style:italic;">name</span><span style="color:#89DDFF;font-style:italic;">=</span><span style="color:#89DDFF;font-style:italic;">&quot;</span><span style="color:#C3E88D;font-style:italic;">e</span><span style="color:#89DDFF;font-style:italic;">&quot;</span><span style="color:#89DDFF;font-style:italic;">&gt;&lt;/</span><span style="color:#F07178;font-style:italic;">param</span><span style="color:#89DDFF;font-style:italic;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">App_AutoUpdateEvent</span><span style="color:#89DDFF;">(object?</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">XT</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Common</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Interfaces</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">IApiConfig</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">e</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">UpdateHelper</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">AutoCallUpdate</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemoteApiUrl</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><ol start="2"><li>android版本</li></ol><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#FFCB6B;">Activity</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">Label</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">AvaloniaXT.Android</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">Theme</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@style/MyTheme.NoActionBar</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">Icon</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">@drawable/icon</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">MainLauncher</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">ConfigurationChanges</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  ConfigChanges</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Orientation </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> ConfigChanges</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ScreenSize </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> ConfigChanges</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">UiMode</span><span style="color:#89DDFF;">)]</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MainActivity</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AvaloniaMainActivity</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">App</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">protected</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">override</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AppBuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">CustomizeAppBuilder</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">AppBuilder</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">builder</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          App</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">InitializingEvent </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> App_InitializingEvent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">base</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CustomizeAppBuilder</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">builder</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithInterFont</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">App_InitializingEvent</span><span style="color:#89DDFF;">(object?</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sender</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Microsoft</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Extensions</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">DependencyInjection</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">ServiceCollection</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">e</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">InitializeOthers</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">          e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">IPlatformService</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AndroidPlatformService</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// AdroidPlatformService 更新</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AndroidPlatformService</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">IPlatformService</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">event</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">EventHandler</span><span style="color:#89DDFF;">&lt;int&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">RefreshEvent</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">IHttpClientFactory</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">_httpClientFactory</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ErrorMsg</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">get</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">set</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">totalBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">private</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">long</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">receivedBytes</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AndroidPlatformService</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IHttpClientFactory</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">httpClientFactory</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          _httpClientFactory </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> httpClientFactory</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">&lt;bool&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">RequestStoragePermissionAsync</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">// 使用 Xamarin.Essentials 或 MAUI 的权限 API</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> Permissions</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">RequestAsync</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">Permissions</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">StorageWrite</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> status </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> PermissionStatus</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Granted</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ShowToastAsync</span><span style="color:#89DDFF;">(string</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">message</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">OperatingSystem</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">IsAndroid</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span></span>
<span class="line"><span style="color:#A6ACCD;">              Toast</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">MakeText</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Application</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Context</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> message</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> ToastLength</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Short</span><span style="color:#89DDFF;">)!.</span><span style="color:#82AAFF;">Show</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">else</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">              </span><span style="color:#676E95;font-style:italic;">// 其他平台的实现</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Task</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">CompletedTask</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">InstallApk</span><span style="color:#89DDFF;">(string</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">path</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">context</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> Application</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Context</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">file</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Java</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">IO</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">File</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">path</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#A6ACCD;">file</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Exists</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ShowToastAsync</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">APK文件不存在</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          file</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SetReadable</span><span style="color:#89DDFF;">(</span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">);</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 允许其他应用读取</span></span>
<span class="line"><span style="color:#A6ACCD;">          file</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SetWritable</span><span style="color:#89DDFF;">(</span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">authority</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$&quot;{</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PackageName</span><span style="color:#89DDFF;">}</span><span style="color:#C3E88D;">.fileprovider</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">uri</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> AndroidX</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Core</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Content</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">FileProvider</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetUriForFile</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> authority</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> file</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">intent</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Intent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Intent</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ActionView</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">SetDataAndType</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">uri</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">application/vnd.android.package-archive</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddFlags</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">ActivityFlags</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NewTask </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> ActivityFlags</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">GrantReadUriPermission</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ResolveActivity</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">context</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PackageManager</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              context</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">StartActivity</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">intent</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">else</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ShowToastAsync</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">没有找到安装程序</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">//var context = Application.Context;</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">//var fileUri = Microsoft.Maui.Storage.FileProvider.GetUriForFile(context, context.PackageName + &quot;.fileprovider&quot;, new Java.IO.File(path));</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">//var intent = new Intent(Intent.ActionView);</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">//intent.SetDataAndType(fileUri, &quot;application/vnd.android.package-archive&quot;);</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">//intent.AddFlags(ActivityFlags.GrantReadUriPermission | ActivityFlags.NewTask);</span></span>
<span class="line"><span style="color:#89DDFF;">          </span><span style="color:#676E95;font-style:italic;">//context.StartActivity(intent);</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">async</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Task</span><span style="color:#89DDFF;">&lt;bool&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">DownloadFileAsync</span><span style="color:#89DDFF;">(string</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">fileUrl</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">string</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">outputPath</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          totalBytes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          receivedBytes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          RefreshEvent</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">this</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">         </span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">using</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">client</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> _httpClientFactory</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CreateClient</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">          client</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DefaultRequestHeaders</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Accept</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Clear</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#A6ACCD;">          client</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">DefaultRequestHeaders</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Accept</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Add</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MediaTypeWithQualityHeaderValue</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">application/octet-stream</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">try</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">              </span><span style="color:#676E95;font-style:italic;">// 异步地获取响应</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">using</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">response</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> client</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">fileUrl</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> HttpCompletionOption</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ResponseHeadersRead</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">EnsureSuccessStatusCode</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">              </span><span style="color:#676E95;font-style:italic;">// 获取文件总大小</span></span>
<span class="line"><span style="color:#A6ACCD;">              totalBytes </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Content</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Headers</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ContentLength </span><span style="color:#89DDFF;">??</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">              </span><span style="color:#676E95;font-style:italic;">// 获取输入流</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">using</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">inputStream</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> response</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Content</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReadAsStreamAsync</span><span style="color:#89DDFF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">              </span><span style="color:#676E95;font-style:italic;">// 创建输出文件流</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">using</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">outputStream</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IO</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">File</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Create</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">outputPath</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">buffer</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">byte[</span><span style="color:#F78C6C;">8192</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">bytesRead</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">              </span><span style="color:#676E95;font-style:italic;">// 读取数据并写入输出文件，同时更新进度</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">bytesRead </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> inputStream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">ReadAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">buffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> buffer</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Length</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">                  </span><span style="color:#676E95;font-style:italic;">// 在异步任务中写入输出流</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> outputStream</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WriteAsync</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">buffer</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> bytesRead</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                  receivedBytes </span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> bytesRead</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">                  </span><span style="color:#676E95;font-style:italic;">// 计算进度并更新 UI 线程</span></span>
<span class="line"><span style="color:#A6ACCD;">                  </span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">value</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(int)((</span><span style="color:#A6ACCD;">receivedBytes </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(double)</span><span style="color:#A6ACCD;">totalBytes</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                  RefreshEvent</span><span style="color:#89DDFF;">?.</span><span style="color:#82AAFF;">Invoke</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">this</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">// 下载完成</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">Exception</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ex</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">await</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">ShowToastAsync</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">$&quot;</span><span style="color:#C3E88D;">下载失败: </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;">ex</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Message</span><span style="color:#89DDFF;">}&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#FF9CAC;">false</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="_3、新建页面程序集" tabindex="-1">3、新建页面程序集 <a class="header-anchor" href="#_3、新建页面程序集" aria-label="Permalink to &quot;3、新建页面程序集&quot;">​</a></h2><h3 id="_3-1、代码结构" tabindex="-1">3.1、代码结构 <a class="header-anchor" href="#_3-1、代码结构" aria-label="Permalink to &quot;3.1、代码结构&quot;">​</a></h3><ol><li><p>Assets文件夹，新增 App.json，作为配置文件，需要在服务中设置IApiConfig的RemoteApiUrl</p></li><li><p>Lanuages文件夹，新增 EN-US.json和ZH-CN.json文件，多语言配置，需要包含菜单名称</p></li></ol><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">MainTitle</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Test System</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">MenuTitle</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Test</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><ol start="3"><li>Services文件夹，新增MenuToolService.cs和StartupService.cs,作为入口配置服务</li></ol><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MenuToolService</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IConfiguration</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">configuration</span><span style="color:#89DDFF;">,</span><span style="color:#FFCB6B;">IApiConfig</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">apiConfig</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">      apiConfig</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">RemoteApiUrl </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> configuration</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">AppSettings:RemoteApiUrl</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="_3-2、服务注入register-cs" tabindex="-1">3.2、服务注入Register.cs <a class="header-anchor" href="#_3-2、服务注入register-cs" aria-label="Permalink to &quot;3.2、服务注入Register.cs&quot;">​</a></h2><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Register</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// 初始化程序集服务</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// </span><span style="color:#89DDFF;font-style:italic;">&lt;/</span><span style="color:#F07178;font-style:italic;">summary</span><span style="color:#89DDFF;font-style:italic;">&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">/// </span><span style="color:#89DDFF;font-style:italic;">&lt;</span><span style="color:#F07178;font-style:italic;">param</span><span style="color:#89DDFF;font-style:italic;"> </span><span style="color:#C792EA;font-style:italic;">name</span><span style="color:#89DDFF;font-style:italic;">=</span><span style="color:#89DDFF;font-style:italic;">&quot;</span><span style="color:#C3E88D;font-style:italic;">services</span><span style="color:#89DDFF;font-style:italic;">&quot;</span><span style="color:#89DDFF;font-style:italic;">&gt;&lt;/</span><span style="color:#F07178;font-style:italic;">param</span><span style="color:#89DDFF;font-style:italic;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">InitializeOthers</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">this</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">ServiceCollection</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">services</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">IMenuToolService</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MenuToolService</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">        services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">IStartupService</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">StartupService</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"><span style="color:#A6ACCD;">        services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">EcsTagApi</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">langurage</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> App</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Provider</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetService</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">AvaloniaXT</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Services</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Language</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">//添加语言配置文件</span></span>
<span class="line"><span style="color:#A6ACCD;">        langurage</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddLangUrl</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AvaloniaXT</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Models</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">LangUrl</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            LangType </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ZH-CN</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            LangConfigUrl </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">avares://ExternalPage/Languages/ZH-CN.json</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"><span style="color:#A6ACCD;">        langurage</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddLangUrl</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">AvaloniaXT</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">Models</span><span style="color:#89DDFF;">.</span><span style="color:#FFCB6B;">LangUrl</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">            LangType </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">EN-US</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">            LangConfigUrl </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">avares://ExternalPage/Languages/EN-US.json</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">InitialJsonConfig</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ExternalPage/Assets/App.json</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">        services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">XTPageBase</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">DemoViewModel</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">        </span><span style="color:#676E95;font-style:italic;">// 弹窗</span></span>
<span class="line"><span style="color:#A6ACCD;">        services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddTransient</span><span style="color:#89DDFF;">&lt;</span><span style="color:#FFCB6B;">DetailPageDialogViewModel</span><span style="color:#89DDFF;">&gt;();</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span></code></pre></div><h2 id="_4、相关用法" tabindex="-1">4、相关用法 <a class="header-anchor" href="#_4、相关用法" aria-label="Permalink to &quot;4、相关用法&quot;">​</a></h2><h3 id="_4-1、弹窗" tabindex="-1">4.1、弹窗 <a class="header-anchor" href="#_4-1、弹窗" aria-label="Permalink to &quot;4.1、弹窗&quot;">​</a></h3><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">DialogBuilder</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">DetailPageDialogViewModel</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Create</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithConfiguration</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">vm</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              vm</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Detais </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> detail</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">})</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">WithTitle</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Language</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Lang</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">StackerEquipment</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">:</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> tag</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Id</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Show</span><span style="color:#89DDFF;">();</span></span></code></pre></div><h3 id="_4-2、右下角弹窗" tabindex="-1">4.2、右下角弹窗 <a class="header-anchor" href="#_4-2、右下角弹窗" aria-label="Permalink to &quot;4.2、右下角弹窗&quot;">​</a></h3><div class="language-c#"><button title="Copy Code" class="copy"></button><span class="lang">c#</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> ISukiToastManager ToastManager </span><span style="color:#89DDFF;">{</span><span style="color:#A6ACCD;"> get</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">ToastManager</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">CreateSimpleInfoToast</span><span style="color:#89DDFF;">().</span><span style="color:#82AAFF;">OfType</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">Avalonia</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Controls</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Notifications</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">NotificationType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Error</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">WithTitle</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ERROR</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">WithContent</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Content</span><span style="color:#89DDFF;">).</span><span style="color:#82AAFF;">Queue</span><span style="color:#89DDFF;">();</span></span></code></pre></div>`,54),t=[e];function c(r,D,y,C,A,F){return n(),a("div",null,t)}const d=s(o,[["render",c]]);export{u as __pageData,d as default};
